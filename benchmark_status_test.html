<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Benchmark Status Test</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            background-color: #f5f5f5;
        }
        h1, h2, h3 {
            color: #334155;
        }
        button {
            background-color: #3b82f6;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #2563eb;
        }
        .controls {
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f0f4f8;
            border-radius: 5px;
            border: 1px solid #cbd5e1;
        }
        .test-section {
            margin-bottom: 30px;
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }
        .benchmark-display {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
        }
        .benchmark-card {
            width: 300px;
            padding: 15px;
            border-radius: 6px;
            border: 1px solid #e2e8f0;
            position: relative;
        }
        .benchmark-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .status-badge {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        .status-in-progress {
            background-color: #e0f2fe;
            color: #0369a1;
        }
        .status-complete {
            background-color: #dcfce7;
            color: #166534;
        }
        .status-error {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .grid-view {
            margin-bottom: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        table th, table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e2e8f0;
        }
        table th {
            background-color: #f1f5f9;
            font-weight: 600;
        }
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-dot.running {
            background-color: #3b82f6;
        }
        .status-dot.complete {
            background-color: #22c55e;
        }
        .model-completion {
            margin-bottom: 8px;
            padding: 8px;
            background-color: #f8fafc;
            border-radius: 4px;
            border-left: 3px solid #94a3b8;
        }
        .model-complete {
            border-left-color: #22c55e;
        }
        .model-running {
            border-left-color: #3b82f6;
        }
        .scenario-controls {
            margin-top: 10px;
            padding: 10px;
            background-color: #f8fafc;
            border-radius: 4px;
        }
        pre {
            background-color: #f1f5f9;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .log {
            max-height: 200px;
            overflow-y: auto;
            margin-top: 15px;
            padding: 10px;
            background-color: #1e293b;
            color: #f8fafc;
            font-family: monospace;
            border-radius: 5px;
        }
        .log-entry {
            margin: 5px 0;
            line-height: 1.4;
        }
        .log-entry.error {
            color: #fca5a5;
        }
        .log-entry.success {
            color: #86efac;
        }
        .log-entry.info {
            color: #93c5fd;
        }
    </style>
</head>
<body>
    <h1>Benchmark Status Test Tool</h1>
    <p>This tool tests how benchmark statuses are displayed in both Grid View and Table View,
       to identify inconsistencies in status representation across different parts of the UI.</p>

    <div class="controls">
        <h2>Test Controls</h2>
        <button id="reset-test">Reset All Tests</button>
        <button id="run-all-tests">Run All Tests</button>
        <div id="log" class="log"></div>
    </div>

    <div class="test-section">
        <h2>Scenario 1: New Benchmark With Two Models</h2>
        <p>Tests how a newly created benchmark appears when multiple models are running.</p>

        <div class="scenario-controls">
            <button id="create-new-benchmark">Create New Benchmark</button>
            <button id="complete-model1">Complete First Model</button>
            <button id="complete-model2">Complete Second Model</button>
            <button id="reset-scenario1">Reset</button>
        </div>

        <div class="benchmark-display">
            <div class="grid-view">
                <h3>Grid View</h3>
                <div id="grid-view-scenario1"></div>
            </div>
            
            <div class="table-view">
                <h3>Table View</h3>
                <div id="table-view-scenario1"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Scenario 2: Benchmark Status During Refresh</h2>
        <p>Tests if benchmark status is preserved correctly during UI refreshes.</p>

        <div class="scenario-controls">
            <button id="create-benchmark-refresh">Create Benchmark</button>
            <button id="complete-one-model">Complete One Model</button>
            <button id="simulate-refresh">Simulate UI Refresh</button>
            <button id="reset-scenario2">Reset</button>
        </div>

        <div class="benchmark-display">
            <div class="grid-view">
                <h3>Grid View (Before Refresh)</h3>
                <div id="grid-view-scenario2-before"></div>
            </div>
            
            <div class="grid-view">
                <h3>Grid View (After Refresh)</h3>
                <div id="grid-view-scenario2-after"></div>
            </div>
        </div>

        <div class="benchmark-display">
            <div class="table-view">
                <h3>Table View (Before Refresh)</h3>
                <div id="table-view-scenario2-before"></div>
            </div>
            
            <div class="table-view">
                <h3>Table View (After Refresh)</h3>
                <div id="table-view-scenario2-after"></div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Scenario 3: Deleted Benchmark Reappearance</h2>
        <p>Tests if deleted benchmarks reappear after creating new benchmarks.</p>

        <div class="scenario-controls">
            <button id="create-benchmarks">Create 2 Benchmarks</button>
            <button id="delete-benchmark">Delete First Benchmark</button>
            <button id="create-new-after-delete">Create New Benchmark</button>
            <button id="reset-scenario3">Reset</button>
        </div>

        <div class="benchmark-display">
            <div class="grid-view">
                <h3>Grid View</h3>
                <div id="grid-view-scenario3"></div>
            </div>
            
            <div class="table-view">
                <h3>Table View</h3>
                <div id="table-view-scenario3"></div>
            </div>
        </div>
    </div>

    <script>
        // Utility functions
        function log(message, type = 'info') {
            const logEl = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function renderGridBenchmark(benchmark, container) {
            const card = document.createElement('div');
            card.className = 'benchmark-card';
            card.dataset.id = benchmark.id;
            card.dataset.status = benchmark.status === 'complete' ? 'complete' : 'in-progress';

            const isInProgress = benchmark.status !== 'complete';
            const statusClass = isInProgress ? 'status-in-progress' : 'status-complete';
            const statusText = isInProgress ? 'IN PROGRESS' : 'COMPLETE';

            card.innerHTML = `
                <div class="benchmark-header">
                    <h3>${benchmark.label}</h3>
                    <span class="status-badge ${statusClass}">${statusText}</span>
                </div>
                <p>${new Date(benchmark.timestamp).toLocaleString()}</p>
                <div class="benchmark-models">
                    <div>Models: ${benchmark.models.join(', ')}</div>
                    ${benchmark.modelStatus ? `
                        <div class="model-status">
                            ${Object.entries(benchmark.modelStatus).map(([model, status]) => `
                                <div class="model-completion ${status === 'complete' ? 'model-complete' : 'model-running'}">
                                    ${model}: ${status === 'complete' ? 'Complete' : 'Running'}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;

            container.appendChild(card);
            log(`Grid view rendered benchmark ${benchmark.id} with status "${benchmark.status}"`, 'info');
        }

        function renderTableBenchmark(benchmarks, container) {
            const table = document.createElement('table');
            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Label</th>
                        <th>Date</th>
                        <th>Models</th>
                    </tr>
                </thead>
                <tbody></tbody>
            `;

            const tbody = table.querySelector('tbody');
            
            benchmarks.forEach(benchmark => {
                const tr = document.createElement('tr');
                tr.dataset.id = benchmark.id;
                
                const isInProgress = benchmark.status !== 'complete';
                const statusDotClass = isInProgress ? 'running' : 'complete';
                
                tr.innerHTML = `
                    <td><span class="status-dot ${statusDotClass}"></span></td>
                    <td>${benchmark.label}</td>
                    <td>${benchmark.timestamp}</td>
                    <td>${benchmark.models.join(', ')}</td>
                `;
                
                tbody.appendChild(tr);
            });
            
            container.innerHTML = '';
            container.appendChild(table);
            log(`Table view rendered ${benchmarks.length} benchmarks`, 'info');
        }

        // Scenario 1: New Benchmark With Two Models
        let scenario1Benchmark = null;
        
        document.getElementById('create-new-benchmark').addEventListener('click', () => {
            const gridContainer = document.getElementById('grid-view-scenario1');
            const tableContainer = document.getElementById('table-view-scenario1');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            scenario1Benchmark = {
                id: 1,
                label: 'Multi-Model Test',
                status: 'running',
                timestamp: new Date().toISOString(),
                models: ['gpt-4-turbo', 'gemini-1.5-pro'],
                modelStatus: {
                    'gpt-4-turbo': 'running',
                    'gemini-1.5-pro': 'running'
                }
            };
            
            renderGridBenchmark(scenario1Benchmark, gridContainer);
            renderTableBenchmark([scenario1Benchmark], tableContainer);
            
            log('Created new benchmark with 2 models', 'success');
        });
        
        document.getElementById('complete-model1').addEventListener('click', () => {
            if (!scenario1Benchmark) {
                log('Please create a benchmark first', 'error');
                return;
            }
            
            scenario1Benchmark.modelStatus['gpt-4-turbo'] = 'complete';
            
            // Critical test: status should remain running until all models complete
            const gridContainer = document.getElementById('grid-view-scenario1');
            const tableContainer = document.getElementById('table-view-scenario1');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            renderGridBenchmark(scenario1Benchmark, gridContainer);
            renderTableBenchmark([scenario1Benchmark], tableContainer);
            
            log('First model completed, benchmark should still show "In Progress"', 'info');
        });
        
        document.getElementById('complete-model2').addEventListener('click', () => {
            if (!scenario1Benchmark) {
                log('Please create a benchmark first', 'error');
                return;
            }
            
            scenario1Benchmark.modelStatus['gemini-1.5-pro'] = 'complete';
            scenario1Benchmark.status = 'complete'; // Now all models are complete
            
            const gridContainer = document.getElementById('grid-view-scenario1');
            const tableContainer = document.getElementById('table-view-scenario1');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            renderGridBenchmark(scenario1Benchmark, gridContainer);
            renderTableBenchmark([scenario1Benchmark], tableContainer);
            
            log('All models completed, benchmark should show "Complete" in both views', 'success');
        });
        
        document.getElementById('reset-scenario1').addEventListener('click', () => {
            scenario1Benchmark = null;
            document.getElementById('grid-view-scenario1').innerHTML = '';
            document.getElementById('table-view-scenario1').innerHTML = '';
            log('Reset Scenario 1', 'info');
        });

        // Scenario 2: Status During Refresh
        let scenario2Benchmark = null;
        let scenario2BeforeRefresh = null;
        
        document.getElementById('create-benchmark-refresh').addEventListener('click', () => {
            const gridBeforeContainer = document.getElementById('grid-view-scenario2-before');
            const tableBeforeContainer = document.getElementById('table-view-scenario2-before');
            
            gridBeforeContainer.innerHTML = '';
            tableBeforeContainer.innerHTML = '';
            document.getElementById('grid-view-scenario2-after').innerHTML = '';
            document.getElementById('table-view-scenario2-after').innerHTML = '';
            
            scenario2Benchmark = {
                id: 2,
                label: 'Refresh Test',
                status: 'running',
                timestamp: new Date().toISOString(),
                models: ['gpt-4-turbo', 'gemini-1.5-pro'],
                modelStatus: {
                    'gpt-4-turbo': 'running',
                    'gemini-1.5-pro': 'running'
                }
            };
            
            renderGridBenchmark(scenario2Benchmark, gridBeforeContainer);
            renderTableBenchmark([scenario2Benchmark], tableBeforeContainer);
            
            log('Created benchmark for refresh test', 'success');
        });
        
        document.getElementById('complete-one-model').addEventListener('click', () => {
            if (!scenario2Benchmark) {
                log('Please create a benchmark first', 'error');
                return;
            }
            
            scenario2Benchmark.modelStatus['gpt-4-turbo'] = 'complete';
            
            const gridBeforeContainer = document.getElementById('grid-view-scenario2-before');
            const tableBeforeContainer = document.getElementById('table-view-scenario2-before');
            
            gridBeforeContainer.innerHTML = '';
            tableBeforeContainer.innerHTML = '';
            
            renderGridBenchmark(scenario2Benchmark, gridBeforeContainer);
            renderTableBenchmark([scenario2Benchmark], tableBeforeContainer);
            
            // Save the state before refresh
            scenario2BeforeRefresh = JSON.parse(JSON.stringify(scenario2Benchmark));
            
            log('One model completed, saved state before refresh', 'info');
        });
        
        document.getElementById('simulate-refresh').addEventListener('click', () => {
            if (!scenario2BeforeRefresh) {
                log('Please complete at least one model first', 'error');
                return;
            }
            
            // SIMULATE THE BUG: UI refresh loses status of in-progress benchmarks
            // Backend reports complete when actually one model is still running
            const simulatedBackendResponse = {
                ...scenario2BeforeRefresh,
                status: 'complete' // Backend incorrectly reports complete
            };
            
            const gridAfterContainer = document.getElementById('grid-view-scenario2-after');
            const tableAfterContainer = document.getElementById('table-view-scenario2-after');
            
            gridAfterContainer.innerHTML = '';
            tableAfterContainer.innerHTML = '';
            
            renderGridBenchmark(simulatedBackendResponse, gridAfterContainer);
            renderTableBenchmark([simulatedBackendResponse], tableAfterContainer);
            
            log('Simulated refresh with incorrect backend "complete" status', 'error');
            log('BUG: After refresh, status may show "Complete" even though one model is still running', 'error');
        });
        
        document.getElementById('reset-scenario2').addEventListener('click', () => {
            scenario2Benchmark = null;
            scenario2BeforeRefresh = null;
            document.getElementById('grid-view-scenario2-before').innerHTML = '';
            document.getElementById('table-view-scenario2-before').innerHTML = '';
            document.getElementById('grid-view-scenario2-after').innerHTML = '';
            document.getElementById('table-view-scenario2-after').innerHTML = '';
            log('Reset Scenario 2', 'info');
        });

        // Scenario 3: Deleted Benchmark Reappearance
        let scenario3Benchmarks = [];
        let deletedBenchmarkIds = new Set();
        
        document.getElementById('create-benchmarks').addEventListener('click', () => {
            const gridContainer = document.getElementById('grid-view-scenario3');
            const tableContainer = document.getElementById('table-view-scenario3');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            scenario3Benchmarks = [
                {
                    id: 31,
                    label: 'First Benchmark',
                    status: 'complete',
                    timestamp: new Date().toISOString(),
                    models: ['gpt-4-turbo']
                },
                {
                    id: 32,
                    label: 'Second Benchmark',
                    status: 'running',
                    timestamp: new Date().toISOString(),
                    models: ['gemini-1.5-pro']
                }
            ];
            
            scenario3Benchmarks.forEach(b => renderGridBenchmark(b, gridContainer));
            renderTableBenchmark(scenario3Benchmarks, tableContainer);
            
            log('Created 2 benchmarks for deletion test', 'success');
        });
        
        document.getElementById('delete-benchmark').addEventListener('click', () => {
            if (scenario3Benchmarks.length === 0) {
                log('Please create benchmarks first', 'error');
                return;
            }
            
            const benchmarkToDelete = scenario3Benchmarks[0]; // First benchmark
            deletedBenchmarkIds.add(benchmarkToDelete.id);
            
            // Remove from the array
            scenario3Benchmarks = scenario3Benchmarks.filter(b => b.id !== benchmarkToDelete.id);
            
            const gridContainer = document.getElementById('grid-view-scenario3');
            const tableContainer = document.getElementById('table-view-scenario3');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            scenario3Benchmarks.forEach(b => renderGridBenchmark(b, gridContainer));
            renderTableBenchmark(scenario3Benchmarks, tableContainer);
            
            log(`Deleted benchmark ${benchmarkToDelete.id}`, 'info');
        });
        
        document.getElementById('create-new-after-delete').addEventListener('click', () => {
            if (scenario3Benchmarks.length === 0) {
                log('Please create benchmarks first', 'error');
                return;
            }
            
            // SIMULATE THE BUG: Backend returns deleted benchmarks
            const simulatedBackendResponse = [
                {
                    id: 31, // This is the deleted benchmark!
                    label: 'First Benchmark (DELETED)',
                    status: 'complete',
                    timestamp: new Date().toISOString(),
                    models: ['gpt-4-turbo']
                },
                ...scenario3Benchmarks,
                {
                    id: 33,
                    label: 'New Benchmark',
                    status: 'running',
                    timestamp: new Date().toISOString(),
                    models: ['gemini-1.5-pro']
                }
            ];
            
            const gridContainer = document.getElementById('grid-view-scenario3');
            const tableContainer = document.getElementById('table-view-scenario3');
            
            gridContainer.innerHTML = '';
            tableContainer.innerHTML = '';
            
            // DEMONSTRATE THE FIX: Filter out deleted benchmarks
            const filteredBenchmarks = simulatedBackendResponse.filter(b => !deletedBenchmarkIds.has(b.id));
            
            log(`Backend returned ${simulatedBackendResponse.length} benchmarks including deleted ones`, 'error');
            log(`After filtering: ${filteredBenchmarks.length} benchmarks (deleted ones removed)`, 'success');
            
            filteredBenchmarks.forEach(b => renderGridBenchmark(b, gridContainer));
            renderTableBenchmark(filteredBenchmarks, tableContainer);
        });
        
        document.getElementById('reset-scenario3').addEventListener('click', () => {
            scenario3Benchmarks = [];
            deletedBenchmarkIds.clear();
            document.getElementById('grid-view-scenario3').innerHTML = '';
            document.getElementById('table-view-scenario3').innerHTML = '';
            log('Reset Scenario 3', 'info');
        });

        // Global controls
        document.getElementById('reset-test').addEventListener('click', () => {
            // Reset all scenarios
            document.getElementById('reset-scenario1').click();
            document.getElementById('reset-scenario2').click();
            document.getElementById('reset-scenario3').click();
            document.getElementById('log').innerHTML = '';
            log('Reset all tests', 'info');
        });
        
        document.getElementById('run-all-tests').addEventListener('click', () => {
            // Run all scenarios automatically
            document.getElementById('reset-test').click();
            
            // Scenario 1
            log('Running Scenario 1: New Benchmark With Two Models', 'info');
            document.getElementById('create-new-benchmark').click();
            setTimeout(() => {
                document.getElementById('complete-model1').click();
                setTimeout(() => {
                    document.getElementById('complete-model2').click();
                    runScenario2();
                }, 1000);
            }, 1000);
            
            function runScenario2() {
                log('Running Scenario 2: Benchmark Status During Refresh', 'info');
                document.getElementById('create-benchmark-refresh').click();
                setTimeout(() => {
                    document.getElementById('complete-one-model').click();
                    setTimeout(() => {
                        document.getElementById('simulate-refresh').click();
                        runScenario3();
                    }, 1000);
                }, 1000);
            }
            
            function runScenario3() {
                log('Running Scenario 3: Deleted Benchmark Reappearance', 'info');
                document.getElementById('create-benchmarks').click();
                setTimeout(() => {
                    document.getElementById('delete-benchmark').click();
                    setTimeout(() => {
                        document.getElementById('create-new-after-delete').click();
                        log('All test scenarios completed', 'success');
                    }, 1000);
                }, 1000);
            }
        });

        // Initialize with some basic logging
        log('Test tool initialized. Click "Run All Tests" to automatically run all scenarios.', 'info');
        log('Or use the individual scenario controls to test specific behaviors.', 'info');
    </script>
</body>
</html>
